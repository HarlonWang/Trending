name: Android Release

on:
  push:
    tags:
      - '[0-9]+.[0-9]+.[0-9]+*' # åŒ¹é… 1.0.0, 1.2.3-alpha ç­‰æ ¼å¼

permissions:
  contents: write

jobs:
  build-and-release:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set up JDK 17
        uses: actions/setup-java@v4
        with:
          java-version: '17'
          distribution: 'temurin'
          cache: gradle

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Prepare Version Info
        run: |
          # ç›´æ¥ä½¿ç”¨ tag åç§° (ä¾‹å¦‚ 1.0.0)
          echo "VERSION_NAME=${{ github.ref_name }}" >> $GITHUB_ENV
          echo "BUILD_NUMBER=${{ github.run_number }}" >> $GITHUB_ENV

      - name: Decode Keystore
        run: |
          # ä» Secrets è¯»å– Base64 å¹¶è¿˜åŸä¸ºæ–‡ä»¶
          echo "${{ secrets.ANDROID_KEYSTORE_BASE64 }}" | base64 --decode > release.jks
          echo "ANDROID_KEYSTORE_PATH=$(pwd)/release.jks" >> $GITHUB_ENV

      - name: Build Release APK
        run: ./gradlew :androidApp:assembleRelease
        env:
          ANDROID_KEYSTORE_PASSWORD: ${{ secrets.ANDROID_KEYSTORE_PASSWORD }}
          ANDROID_KEY_ALIAS: ${{ secrets.ANDROID_KEY_ALIAS }}
          ANDROID_KEY_PASSWORD: ${{ secrets.ANDROID_KEY_PASSWORD }}

      - name: Generate Release Notes
        run: |
          # è·å– commit è®°å½•
          PREVIOUS_TAG=$(git tag --sort=-v:refname | grep -E '^[0-9]+\.[0-9]+\.[0-9]+' | grep -v "${{ github.ref_name }}" | head -n 1)
          if [ -n "$PREVIOUS_TAG" ]; then
            COMMIT_LOGS=$(git log "$PREVIOUS_TAG"..HEAD --no-merges --oneline)
          else
            COMMIT_LOGS=$(git log --no-merges --oneline -n 20)
          fi
          
          # ä¿®å¤å˜é‡ä¼ é€’é—®é¢˜ï¼šç›´æ¥å°†å˜é‡å†…å®¹å­˜å…¥ä¸´æ—¶æ–‡ä»¶ï¼Œä¾› Python è¯»å–
          echo "$COMMIT_LOGS" > commit_logs.txt
          
          python3 - <<'EOF'
          import os
          import json
          import urllib.request
          
          # ä»ä¸´æ—¶æ–‡ä»¶è¯»å– commit è®°å½•
          if os.path.exists("commit_logs.txt"):
              with open("commit_logs.txt", "r") as f:
                  commits = f.read().strip()
          else:
              commits = ""
              
          api_key = os.environ.get("OPENAI_API_KEY", "")
          api_url = "https://api.openai.com/v1/chat/completions"
          
          fallback_text = "### å˜æ›´è®°å½• (Changelog)\n\n" + commits
          
          if not commits:
              with open("release_summary.md", "w") as f:
                  f.write("### What's Changed\n\n* No specific changes.\n\n")
              exit(0)
              
          if not api_key:
              print("âš ï¸ OPENAI_API_KEY not found. Using fallback.")
              with open("release_summary.md", "w") as f:
                  f.write(fallback_text + "\n\n")
              exit(0)
              
          prompt = f"è¯·æ ¹æ®ä»¥ä¸‹ git commit è®°å½•ï¼Œç”Ÿæˆä¸€ä»½é¢å‘ç”¨æˆ·çš„ Release Notesã€‚\nè¦æ±‚ï¼š\n1. å¿½ç•¥çç¢çš„æ„å»ºæˆ–å†…éƒ¨è°ƒæ•´ï¼Œæ€»ç»“å‡ºæ ¸å¿ƒçš„æ–°ç‰¹æ€§ã€ä¼˜åŒ–å’Œä¿®å¤ã€‚\n2. åŒæ—¶æä¾›æ¸…æ™°çš„ä¸­æ–‡å’Œè‹±æ–‡ç‰ˆæœ¬ï¼ˆè‹±æ–‡åœ¨ä¸Šï¼Œä¸­æ–‡åœ¨ä¸‹ï¼‰ã€‚\n3. ä½¿ç”¨ Markdown åˆ—è¡¨æ ¼å¼ï¼Œä¸è¦è¾“å‡ºè¿‡äºå•°ç¢çš„æŠ€æœ¯æœ¯è¯­ã€‚\n\nCommits:\n{commits}"
          
          data = {
              "model": "gpt-5.1",
              "messages": [{"role": "user", "content": prompt}],
              "temperature": 0.7
          }
          
          req = urllib.request.Request(api_url, data=json.dumps(data).encode("utf-8"), headers={
              "Content-Type": "application/json",
              "Authorization": f"Bearer {api_key}"
          })
          
          try:
              print("Calling ChatGPT API (model: gpt-5.1)...")
              with urllib.request.urlopen(req, timeout=30) as response:
                  res_data = json.loads(response.read().decode("utf-8"))
                  summary = res_data["choices"][0]["message"]["content"]
                  with open("release_summary.md", "w") as f:
                      f.write("### What's Changed\n\n" + summary + "\n\n")
                  print("âœ… ChatGPT generated release notes successfully.")
          except Exception as e:
              print(f"âš ï¸ ChatGPT API call failed: {e}")
              with open("release_summary.md", "w") as f:
                  f.write(fallback_text + "\n\n")
          EOF
        env:
          OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}

      - name: Prepare APK Diff
        id: diffuse
        run: |
          # 1. ä¸‹è½½å¹¶è§£å‹å›ºå®šç‰ˆæœ¬ diffuse 0.3.0
          gh release download 0.3.0 --repo JakeWharton/diffuse --pattern "diffuse-0.3.0.zip" --output diffuse.zip
          unzip -q diffuse.zip
          chmod +x diffuse-0.3.0/bin/diffuse

          # 2. è·å–ä¸Šä¸€ä¸ª Tag
          PREVIOUS_TAG=$(git tag --sort=-v:refname | grep -E '^[0-9]+\.[0-9]+\.[0-9]+' | grep -v "${{ github.ref_name }}" | head -n 1)
          
          NEW_APK=$(find androidApp/build/outputs/apk/release -name "*.apk" | head -n 1)
          
          echo "### Apk Diff" >> release_summary.md
          
          if [ -n "$PREVIOUS_TAG" ]; then
            # 3. ä¸‹è½½æ—§ç‰ˆæœ¬ APK
            mkdir -p old-apk
            if gh release download "$PREVIOUS_TAG" -p "*.apk" --dir old-apk; then
              OLD_APK=$(find old-apk -name "*.apk" | head -n 1)
              
              if [ -n "$OLD_APK" ]; then
                # 4. è¿è¡Œå¯¹æ¯”å¹¶ç”Ÿæˆæ‘˜è¦
                ./diffuse-0.3.0/bin/diffuse diff "$OLD_APK" "$NEW_APK" > diff-apk.txt
                echo '```text' >> release_summary.md
                sed -n '/^=================/q;p' diff-apk.txt >> release_summary.md
                echo '```' >> release_summary.md
              else
                echo "âš ï¸ æœªèƒ½åœ¨ä¸Šä¸€ä¸ª Release ($PREVIOUS_TAG) ä¸­æ‰¾åˆ° APK æ–‡ä»¶ã€‚" >> release_summary.md
              fi
            else
              echo "âš ï¸ æ— æ³•ä¸‹è½½ä¸Šä¸€ä¸ª Release ($PREVIOUS_TAG) çš„äº§ç‰©ã€‚" >> release_summary.md
            fi
          else
            echo "ğŸ†• é¦–æ¬¡å‘å¸ƒï¼Œæ— å†å²ç‰ˆæœ¬å¯¹æ¯”ã€‚" >> release_summary.md
          fi
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Compare Dependencies
        run: |
          PREVIOUS_TAG=$(git tag --sort=-v:refname | grep -E '^[0-9]+\.[0-9]+\.[0-9]+' | grep -v "${{ github.ref_name }}" | head -n 1)
          if [ -n "$PREVIOUS_TAG" ]; then
            git show "$PREVIOUS_TAG:gradle/libs.versions.toml" > old_libs.toml || touch old_libs.toml
            python3 - <<EOF > dep_diff.md
          import sys
          import tomllib
          def load_versions(path):
              try:
                  with open(path, "rb") as f:
                      return tomllib.load(f).get("versions", {})
              except: return {}

          old_v = load_versions("old_libs.toml")
          new_v = load_versions("gradle/libs.versions.toml")
          
          all_keys = sorted(set(old_v.keys()) | set(new_v.keys()))
          changes = []
          for k in all_keys:
              old_val = old_v.get(k)
              new_val = new_v.get(k)
              if old_val != new_val:
                  changes.append((k, old_val if old_val else "None", new_val if new_val else "Removed"))

          if changes:
              print("### Dependency Update\n")
              print("| Dependency | Previous version | New version |")
              print("| :--- | :--- | :--- |")
              for name, old, new in changes:
                  print(f"| {name} | {old} | {new} |")
              print("\n")
          EOF
            if [ -s dep_diff.md ]; then
              # å°†ä¾èµ–å˜æ›´è¿½åŠ åˆ° release_summary.md çš„æœ«å°¾
              cat dep_diff.md >> release_summary.md
            fi
          fi

      - name: Create Release
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          IS_PRERELEASE=""
          if [[ "${{ github.ref_name }}" =~ (alpha|beta|rc) ]]; then
            IS_PRERELEASE="--prerelease"
          fi
          
          # æ”¶é›†å¾…ä¸Šä¼ çš„æ–‡ä»¶
          FILES=(androidApp/build/outputs/apk/release/*.apk)
          if [ -s diff-apk.txt ]; then
            FILES+=("diff-apk.txt")
          fi
          
          gh release create "${{ github.ref_name }}" \
            --title "${{ github.ref_name }}" \
            --notes-file release_summary.md \
            --generate-notes \
            $IS_PRERELEASE \
            "${FILES[@]}"

      - name: Setup AWS CLI for R2
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.R2_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.R2_SECRET_ACCESS_KEY }}
          aws-region: us-east-1

      - name: Upload APK to Cloudflare R2
        env:
          ACCOUNT_ID: ${{ secrets.R2_ACCOUNT_ID }}
        run: |
          # åŠ¨æ€å¯»æ‰¾åˆšæ‰æ‰“åŒ…å¥½çš„ APK è·¯å¾„ 
          APK_PATH=$(find androidApp/build/outputs/apk/release -name "*.apk" | head -n 1)
          
          if [ -z "$APK_PATH" ]; then
            echo "Error: APK file not found!"
            exit 1
          fi
          
          echo "Found APK at: $APK_PATH"
          echo "Uploading to R2..."
          
          # æ‰§è¡Œä¸Šä¼ æ“ä½œï¼Œå›ºå®šå‘½åä¸º TrendingAI-latest.apkï¼Œè¦†ç›–ä¸Šä¸€ç‰ˆæœ¬
          # è¯·ç¡®ä¿ s3:// åé¢è·Ÿç€çš„æ˜¯ä½ åœ¨ R2 åˆ›å»ºçš„çœŸå® Bucket åç§°
          aws s3 cp "$APK_PATH" s3://trendingai-apk/TrendingAI-latest.apk \
            --endpoint-url "https://$ACCOUNT_ID.r2.cloudflarestorage.com"
          
          echo "âœ… Upload completed. Download link: https://download.trendingai.cn/TrendingAI-latest.apk"
