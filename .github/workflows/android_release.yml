name: Android Release

on:
  push:
    tags:
      - '[0-9]+.[0-9]+.[0-9]+*' # åŒ¹é… 1.0.0, 1.2.3-alpha ç­‰æ ¼å¼

permissions:
  contents: write

jobs:
  build-and-release:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set up JDK 17
        uses: actions/setup-java@v4
        with:
          java-version: '17'
          distribution: 'temurin'
          cache: gradle

      - name: Prepare Version Info
        run: |
          # ç›´æŽ¥ä½¿ç”¨ tag åç§° (ä¾‹å¦‚ 1.0.0)
          echo "VERSION_NAME=${{ github.ref_name }}" >> $GITHUB_ENV
          echo "BUILD_NUMBER=${{ github.run_number }}" >> $GITHUB_ENV

      - name: Decode Keystore
        run: |
          # ä»Ž Secrets è¯»å– Base64 å¹¶è¿˜åŽŸä¸ºæ–‡ä»¶
          echo "${{ secrets.ANDROID_KEYSTORE_BASE64 }}" | base64 --decode > release.jks
          echo "ANDROID_KEYSTORE_PATH=$(pwd)/release.jks" >> $GITHUB_ENV

      - name: Build Release APK
        run: ./gradlew :androidApp:assembleRelease
        env:
          ANDROID_KEYSTORE_PASSWORD: ${{ secrets.ANDROID_KEYSTORE_PASSWORD }}
          ANDROID_KEY_ALIAS: ${{ secrets.ANDROID_KEY_ALIAS }}
          ANDROID_KEY_PASSWORD: ${{ secrets.ANDROID_KEY_PASSWORD }}

      - name: Prepare APK Diff
        id: diffuse
        run: |
          # 1. ä¸‹è½½å¹¶è§£åŽ‹å›ºå®šç‰ˆæœ¬ diffuse 0.3.0
          gh release download 0.3.0 --repo JakeWharton/diffuse --pattern "diffuse-0.3.0.zip" --output diffuse.zip
          unzip -q diffuse.zip
          chmod +x diffuse-0.3.0/bin/diffuse

          # 2. èŽ·å–ä¸Šä¸€ä¸ª Tag
          PREVIOUS_TAG=$(git tag --sort=-v:refname | grep -E '^[0-9]+\.[0-9]+\.[0-9]+' | grep -v "${{ github.ref_name }}" | head -n 1)
          
          NEW_APK=$(find androidApp/build/outputs/apk/release -name "*.apk" | head -n 1)
          
          echo "### Apk Diff" > release_summary.md
          
          if [ -n "$PREVIOUS_TAG" ]; then
            # 3. ä¸‹è½½æ—§ç‰ˆæœ¬ APK
            mkdir -p old-apk
            if gh release download "$PREVIOUS_TAG" -p "*.apk" --dir old-apk; then
              OLD_APK=$(find old-apk -name "*.apk" | head -n 1)
              
              if [ -n "$OLD_APK" ]; then
                # 4. è¿è¡Œå¯¹æ¯”å¹¶ç”Ÿæˆæ‘˜è¦
                ./diffuse-0.3.0/bin/diffuse diff "$OLD_APK" "$NEW_APK" > diff-apk.txt
                echo '```text' >> release_summary.md
                sed -n '/^=================/q;p' diff-apk.txt >> release_summary.md
                echo '```' >> release_summary.md
              else
                echo "âš ï¸ æœªèƒ½åœ¨ä¸Šä¸€ä¸ª Release ($PREVIOUS_TAG) ä¸­æ‰¾åˆ° APK æ–‡ä»¶ã€‚" >> release_summary.md
              fi
            else
              echo "âš ï¸ æ— æ³•ä¸‹è½½ä¸Šä¸€ä¸ª Release ($PREVIOUS_TAG) çš„äº§ç‰©ã€‚" >> release_summary.md
            fi
          else
            echo "ðŸ†• é¦–æ¬¡å‘å¸ƒï¼Œæ— åŽ†å²ç‰ˆæœ¬å¯¹æ¯”ã€‚" >> release_summary.md
          fi
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Compare Dependencies
        run: |
          PREVIOUS_TAG=$(git tag --sort=-v:refname | grep -E '^[0-9]+\.[0-9]+\.[0-9]+' | grep -v "${{ github.ref_name }}" | head -n 1)
          if [ -n "$PREVIOUS_TAG" ]; then
            git show "$PREVIOUS_TAG:gradle/libs.versions.toml" > old_libs.toml || touch old_libs.toml
            python3 - <<EOF > dep_diff.md
          import sys
          if sys.version_info < (3, 11):
              sys.exit(0)

          import tomllib
          def load_versions(path):
              try:
                  with open(path, "rb") as f:
                      return tomllib.load(f).get("versions", {})
              except: return {}

          old_v = load_versions("old_libs.toml")
          new_v = load_versions("gradle/libs.versions.toml")
          
          all_keys = sorted(set(old_v.keys()) | set(new_v.keys()))
          changes = []
          for k in all_keys:
              old_val = old_v.get(k)
              new_val = new_v.get(k)
              if old_val != new_val:
                  changes.append((k, old_val if old_val else "None", new_val if new_val else "Removed"))

          if changes:
              print("### Dependency Update\n")
              print("| Dependency | Previous version | New version |")
              print("| :--- | :--- | :--- |")
              for name, old, new in changes:
                  print(f"| {name} | {old} | {new} |")
              print("\n")
          EOF
            if [ -s dep_diff.md ]; then
              # å°†ä¾èµ–å˜æ›´è¿½åŠ åˆ° release_summary.md çš„æœ«å°¾
              cat dep_diff.md >> release_summary.md
            fi
          fi

      - name: Create Release
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          IS_PRERELEASE=""
          if [[ "${{ github.ref_name }}" =~ (alpha|beta|rc) ]]; then
            IS_PRERELEASE="--prerelease"
          fi
          
          # æ”¶é›†å¾…ä¸Šä¼ çš„æ–‡ä»¶
          FILES=(androidApp/build/outputs/apk/release/*.apk)
          if [ -s diff-apk.txt ]; then
            FILES+=("diff-apk.txt")
          fi
          
          gh release create "${{ github.ref_name }}" \
            --title "${{ github.ref_name }}" \
            --notes-file release_summary.md \
            --generate-notes \
            $IS_PRERELEASE \
            "${FILES[@]}"
