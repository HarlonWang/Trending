name: Android Release

on:
  push:
    tags:
      - '[0-9]+.[0-9]+.[0-9]+*' # ÂåπÈÖç 1.0.0, 1.2.3-alpha Á≠âÊ†ºÂºè

permissions:
  contents: write

jobs:
  build-and-release:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set up JDK 17
        uses: actions/setup-java@v4
        with:
          java-version: '17'
          distribution: 'temurin'
          cache: gradle

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Prepare Version Info
        run: |
          # Áõ¥Êé•‰ΩøÁî® tag ÂêçÁß∞ (‰æãÂ¶Ç 1.0.0)
          echo "VERSION_NAME=${{ github.ref_name }}" >> $GITHUB_ENV
          echo "BUILD_NUMBER=${{ github.run_number }}" >> $GITHUB_ENV

      - name: Decode Keystore
        run: |
          # ‰ªé Secrets ËØªÂèñ Base64 Âπ∂ËøòÂéü‰∏∫Êñá‰ª∂
          echo "${{ secrets.ANDROID_KEYSTORE_BASE64 }}" | base64 --decode > release.jks
          echo "ANDROID_KEYSTORE_PATH=$(pwd)/release.jks" >> $GITHUB_ENV

      - name: Build Release APK
        run: ./gradlew :androidApp:assembleRelease
        env:
          ANDROID_KEYSTORE_PASSWORD: ${{ secrets.ANDROID_KEYSTORE_PASSWORD }}
          ANDROID_KEY_ALIAS: ${{ secrets.ANDROID_KEY_ALIAS }}
          ANDROID_KEY_PASSWORD: ${{ secrets.ANDROID_KEY_PASSWORD }}

      - name: Generate Release Notes
        run: |
          # Ëé∑Âèñ commit ËÆ∞ÂΩï
          PREVIOUS_TAG=$(git tag --sort=-v:refname | grep -E '^[0-9]+\.[0-9]+\.[0-9]+' | grep -v "${{ github.ref_name }}" | head -n 1)
          if [ -n "$PREVIOUS_TAG" ]; then
            COMMIT_LOGS=$(git log "$PREVIOUS_TAG"..HEAD --no-merges --oneline)
          else
            COMMIT_LOGS=$(git log --no-merges --oneline -n 20)
          fi
          
          # ÂÜôÂÖ•ÁéØÂ¢ÉÂèòÈáè‰æõ Python ËØªÂèñ
          echo "COMMIT_LOGS<<EOF" >> $GITHUB_ENV
          echo "$COMMIT_LOGS" >> $GITHUB_ENV
          echo "EOF" >> $GITHUB_ENV
          
          python3 - <<'EOF'
          import os
          import json
          import urllib.request
          
          commits = os.environ.get("COMMIT_LOGS", "")
          api_key = os.environ.get("OPENAI_API_KEY", "")
          api_url = "https://api.openai.com/v1/chat/completions"
          
          fallback_text = "### ÂèòÊõ¥ËÆ∞ÂΩï (Changelog)\n\n" + commits
          
          if not commits.strip():
              with open("release_summary.md", "w") as f:
                  f.write("### Êõ¥Êñ∞ÂÜÖÂÆπ (Release Notes)\n\n* No specific changes.\n\n")
              exit(0)
              
          if not api_key:
              print("‚ö†Ô∏è OPENAI_API_KEY not found. Using fallback.")
              with open("release_summary.md", "w") as f:
                  f.write(fallback_text + "\n\n")
              exit(0)
              
          prompt = f"ËØ∑Ê†πÊçÆ‰ª•‰∏ã git commit ËÆ∞ÂΩïÔºåÁîüÊàê‰∏Ä‰ªΩÈù¢ÂêëÁî®Êà∑ÁöÑ Release Notes„ÄÇ\nË¶ÅÊ±ÇÔºö\n1. ÂøΩÁï•ÁêêÁ¢éÁöÑÊûÑÂª∫ÊàñÂÜÖÈÉ®Ë∞ÉÊï¥ÔºåÊÄªÁªìÂá∫Ê†∏ÂøÉÁöÑÊñ∞ÁâπÊÄß„ÄÅ‰ºòÂåñÂíå‰øÆÂ§ç„ÄÇ\n2. ÂêåÊó∂Êèê‰æõÊ∏ÖÊô∞ÁöÑ‰∏≠ÊñáÂíåËã±ÊñáÁâàÊú¨ÔºàËã±ÊñáÂú®‰∏äÔºå‰∏≠ÊñáÂú®‰∏ãÔºâ„ÄÇ\n3. ‰ΩøÁî® Markdown ÂàóË°®Ê†ºÂºèÔºå‰∏çË¶ÅËæìÂá∫Ëøá‰∫éÂï∞Á¢éÁöÑÊäÄÊúØÊúØËØ≠„ÄÇ\n\nCommits:\n{commits}"
          
          data = {
              "model": "gpt-5.1",
              "messages": [{"role": "user", "content": prompt}],
              "temperature": 0.7
          }
          
          req = urllib.request.Request(api_url, data=json.dumps(data).encode("utf-8"), headers={
              "Content-Type": "application/json",
              "Authorization": f"Bearer {api_key}"
          })
          
          try:
              print("Calling ChatGPT API (model: gpt-5.1)...")
              with urllib.request.urlopen(req, timeout=30) as response:
                  res_data = json.loads(response.read().decode("utf-8"))
                  summary = res_data["choices"][0]["message"]["content"]
                  with open("release_summary.md", "w") as f:
                      f.write("### Êõ¥Êñ∞ÂÜÖÂÆπ (Release Notes)\n\n" + summary + "\n\n")
                  print("‚úÖ ChatGPT generated release notes successfully.")
          except Exception as e:
              print(f"‚ö†Ô∏è ChatGPT API call failed: {e}")
              with open("release_summary.md", "w") as f:
                  f.write(fallback_text + "\n\n")
          EOF
        env:
          OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}

      - name: Prepare APK Diff
        id: diffuse
        run: |
          # 1. ‰∏ãËΩΩÂπ∂Ëß£ÂéãÂõ∫ÂÆöÁâàÊú¨ diffuse 0.3.0
          gh release download 0.3.0 --repo JakeWharton/diffuse --pattern "diffuse-0.3.0.zip" --output diffuse.zip
          unzip -q diffuse.zip
          chmod +x diffuse-0.3.0/bin/diffuse

          # 2. Ëé∑Âèñ‰∏ä‰∏Ä‰∏™ Tag
          PREVIOUS_TAG=$(git tag --sort=-v:refname | grep -E '^[0-9]+\.[0-9]+\.[0-9]+' | grep -v "${{ github.ref_name }}" | head -n 1)
          
          NEW_APK=$(find androidApp/build/outputs/apk/release -name "*.apk" | head -n 1)
          
          echo "### Apk Diff" >> release_summary.md
          
          if [ -n "$PREVIOUS_TAG" ]; then
            # 3. ‰∏ãËΩΩÊóßÁâàÊú¨ APK
            mkdir -p old-apk
            if gh release download "$PREVIOUS_TAG" -p "*.apk" --dir old-apk; then
              OLD_APK=$(find old-apk -name "*.apk" | head -n 1)
              
              if [ -n "$OLD_APK" ]; then
                # 4. ËøêË°åÂØπÊØîÂπ∂ÁîüÊàêÊëòË¶Å
                ./diffuse-0.3.0/bin/diffuse diff "$OLD_APK" "$NEW_APK" > diff-apk.txt
                echo '```text' >> release_summary.md
                sed -n '/^=================/q;p' diff-apk.txt >> release_summary.md
                echo '```' >> release_summary.md
              else
                echo "‚ö†Ô∏è Êú™ËÉΩÂú®‰∏ä‰∏Ä‰∏™ Release ($PREVIOUS_TAG) ‰∏≠ÊâæÂà∞ APK Êñá‰ª∂„ÄÇ" >> release_summary.md
              fi
            else
              echo "‚ö†Ô∏è Êó†Ê≥ï‰∏ãËΩΩ‰∏ä‰∏Ä‰∏™ Release ($PREVIOUS_TAG) ÁöÑ‰∫ßÁâ©„ÄÇ" >> release_summary.md
            fi
          else
            echo "üÜï È¶ñÊ¨°ÂèëÂ∏ÉÔºåÊó†ÂéÜÂè≤ÁâàÊú¨ÂØπÊØî„ÄÇ" >> release_summary.md
          fi
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Compare Dependencies
        run: |
          PREVIOUS_TAG=$(git tag --sort=-v:refname | grep -E '^[0-9]+\.[0-9]+\.[0-9]+' | grep -v "${{ github.ref_name }}" | head -n 1)
          if [ -n "$PREVIOUS_TAG" ]; then
            git show "$PREVIOUS_TAG:gradle/libs.versions.toml" > old_libs.toml || touch old_libs.toml
            python3 - <<EOF > dep_diff.md
          import sys
          import tomllib
          def load_versions(path):
              try:
                  with open(path, "rb") as f:
                      return tomllib.load(f).get("versions", {})
              except: return {}

          old_v = load_versions("old_libs.toml")
          new_v = load_versions("gradle/libs.versions.toml")
          
          all_keys = sorted(set(old_v.keys()) | set(new_v.keys()))
          changes = []
          for k in all_keys:
              old_val = old_v.get(k)
              new_val = new_v.get(k)
              if old_val != new_val:
                  changes.append((k, old_val if old_val else "None", new_val if new_val else "Removed"))

          if changes:
              print("### Dependency Update\n")
              print("| Dependency | Previous version | New version |")
              print("| :--- | :--- | :--- |")
              for name, old, new in changes:
                  print(f"| {name} | {old} | {new} |")
              print("\n")
          EOF
            if [ -s dep_diff.md ]; then
              # Â∞Ü‰æùËµñÂèòÊõ¥ËøΩÂä†Âà∞ release_summary.md ÁöÑÊú´Â∞æ
              cat dep_diff.md >> release_summary.md
            fi
          fi

      - name: Create Release
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          IS_PRERELEASE=""
          if [[ "${{ github.ref_name }}" =~ (alpha|beta|rc) ]]; then
            IS_PRERELEASE="--prerelease"
          fi
          
          # Êî∂ÈõÜÂæÖ‰∏ä‰º†ÁöÑÊñá‰ª∂
          FILES=(androidApp/build/outputs/apk/release/*.apk)
          if [ -s diff-apk.txt ]; then
            FILES+=("diff-apk.txt")
          fi
          
          gh release create "${{ github.ref_name }}" \
            --title "${{ github.ref_name }}" \
            --notes-file release_summary.md \
            --generate-notes \
            $IS_PRERELEASE \
            "${FILES[@]}"
